---
title: "Vignette illustrating the use of poolscreen on pooled CRISPR screen data"
author: "Katharina Imkeller"
date: "`r Sys.Date()`"
output:
  BiocStyle::html_document:
    toc: true
vignette: >
  %\VignetteIndexEntry{Example_simulated}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
library(poolscreen)
library(tidyverse)
```

# Introduction

What we want to do

Explanation of skewing

What is the benefit from our method

# Poolscreen workflow

Poolscreen takes raw sgRNA/siRNA counts as input. 
The analysis follows the follwing steps:
1. Input of raw counts, normalization and calculation of log fold changes.
2. Split log fold changes into intervals dependent on the initial count at T0.
3. For every interval fit a skew-normal distibution to the data to
model the null hypothesis (via least quantile regression).
4. Based on the null model calculate p-values for every sgRNA.
5. Rank sgRNAs according to p-value and perform robust ranking aggregation to 
calculate p-values on gene level.
6. Perform quality control of data and statistical model.

# Installation

devtools::install_github("imkeller/poolscreen")

# Analyzing pooled screening data with poolscreen

## Input: sgRNA counts

Show where simulated data comes from

Get summarized experiment

Get counts from count file
```{r}
raw_counts <- read.delim("/home/katharina/Documents/synced/method_development/r_package/poolscreen/inst/extdata/simulated_counts.txt",
           sep = "\t")
```

Generate Summarized experiment

```{r}
counts_matrix <- cbind(raw_counts$library0, raw_counts$R0_0, raw_counts$R1_0)

rowData <- data.frame(sgRNA_id = raw_counts$sgrna_id,
                           gene = raw_counts$Gene)

colData <- data.frame(samplename = c("library", "R1", "R2"),
                      # timepoint naming convention: 
                      # T0 -> reference, 
                      # T1 -> selected
                      timepoint = c("T0", "T1", "T1"))

se <- SummarizedExperiment(assays=list(counts=counts_matrix),
                        rowData=rowData, colData=colData)
```

## Generate poolscreen Experiment

What are the names of the samples?

```{r}
pse <- createPoolScreenExp(se)
```

## Run poolscreen

```{r}
pse <- runPoolScreen(pse, 0.1, 0.9, 0.05)

```

## Quality control

Replicate correlations
```{r}
plotReplicateCorrelation(pse)
```

Model parameters

```{r}
plotModelParameters(pse) 
```

# Hit calling

```{r}
data.frame(Name = rownames(assays(pse@GeneData)$fdr_neg),
           fdr = assays(pse@GeneData)$fdr_neg, 
           pval = as.numeric(assays(pse@GeneData)$pvalue_neg[,1]),
           lfc = assays(pse@GeneData)$lfc) %>%
    arrange(pval, lfc)

```

# Literature


# Session

```{r}
SessionInfo()
```
